{
  "entities": {
    "Organization": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Organization",
      "type": "object",
      "description": "Represents an organization (SACCO, Credit Union, etc.) using the Adoo platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Organization entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the organization."
        },
        "tagline": {
          "type": "string",
          "description": "The tagline or brief description of the organization."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Branch": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Branch",
      "type": "object",
      "description": "Represents a branch of an organization.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Branch entity."
        },
        "organizationId": {
          "type": "string",
          "description": "Reference to Organization. (Relationship: Organization 1:N Branch)"
        },
        "name": {
          "type": "string",
          "description": "The name of the branch."
        },
        "location": {
          "type": "string",
          "description": "The location or address of the branch."
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates whether the branch is currently active."
        }
      },
      "required": [
        "id",
        "organizationId",
        "name"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Represents a role within the application (Admin, Manager, Loan Officer, Auditor).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Role entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the role."
        },
        "permissions": {
          "type": "array",
          "description": "References to Permissions. (Relationship: Role 1:N Permission)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "branchIds": {
          "type": "array",
          "description": "References to Branches. (Relationship: User N:N Branch)",
          "items": {
            "type": "string"
          }
        },
        "roleId": {
          "type": "string",
          "description": "Reference to Role. (Relationship: User 1:N Role)"
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName"
      ]
    },
    "Borrower": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Borrower",
      "type": "object",
      "description": "Represents a borrower or client.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Borrower entity."
        },
        "branchId": {
          "type": "string",
          "description": "Reference to Branch. (Relationship: Branch 1:N Borrower)"
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the borrower."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the borrower."
        },
        "dateOfBirth": {
          "type": "string",
          "description": "The date of birth of the borrower.",
          "format": "date-time"
        },
        "gender": {
          "type": "string",
          "description": "The gender of the borrower."
        },
        "nationalId": {
          "type": "string",
          "description": "The national ID or tax ID of the borrower."
        },
        "phoneNumber": {
          "type": "string",
          "description": "The phone number of the borrower."
        },
        "email": {
          "type": "string",
          "description": "The email address of the borrower.",
          "format": "email"
        },
        "address": {
          "type": "string",
          "description": "The address of the borrower."
        },
        "employmentStatus": {
          "type": "string",
          "description": "The employment status of the borrower."
        },
        "employerName": {
          "type": "string",
          "description": "The name of the borrower's employer (optional)."
        },
        "monthlyIncome": {
          "type": "number",
          "description": "The monthly income of the borrower."
        }
      },
      "required": [
        "id",
        "branchId",
        "firstName",
        "lastName",
        "dateOfBirth",
        "gender",
        "nationalId",
        "phoneNumber"
      ]
    },
    "BorrowerDocument": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "BorrowerDocument",
      "type": "object",
      "description": "Represents a document associated with a borrower (ID, contract, collateral).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the BorrowerDocument entity."
        },
        "borrowerId": {
          "type": "string",
          "description": "Reference to Borrower. (Relationship: Borrower 1:N BorrowerDocument)"
        },
        "fileName": {
          "type": "string",
          "description": "The name of the document file."
        },
        "fileType": {
          "type": "string",
          "description": "The type or extension of the document file."
        },
        "fileUrl": {
          "type": "string",
          "description": "The URL or path to the document file in storage.",
          "format": "uri"
        },
        "documentType": {
          "type": "string",
          "description": "Type of the document (e.g., ID, contract, collateral)."
        }
      },
      "required": [
        "id",
        "borrowerId",
        "fileName",
        "fileType",
        "fileUrl",
        "documentType"
      ]
    },
    "LoanProduct": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "LoanProduct",
      "type": "object",
      "description": "Represents a loan product offered by the organization.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the LoanProduct entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the loan product."
        },
        "category": {
          "type": "string",
          "description": "The category of the loan product (Motorcycle, Phone, etc.)."
        },
        "description": {
          "type": "string",
          "description": "A description of the loan product."
        },
        "minLoanAmount": {
          "type": "number",
          "description": "The minimum loan amount for this product."
        },
        "maxLoanAmount": {
          "type": "number",
          "description": "The maximum loan amount for this product."
        },
        "durationRangeWeeks": {
          "type": "number",
          "description": "The duration range in weeks for the loan."
        },
        "interestRate": {
          "type": "number",
          "description": "The simple interest rate (percentage) for the loan product."
        },
        "repaymentCycle": {
          "type": "string",
          "description": "The default repayment cycle (weekly, monthly, custom)."
        },
        "fees": {
          "type": "number",
          "description": "fees of loan product",
          "items": {
            "type": "number"
          }
        }
      },
      "required": [
        "id",
        "name",
        "category",
        "minLoanAmount",
        "maxLoanAmount",
        "durationRangeWeeks",
        "interestRate",
        "repaymentCycle"
      ]
    },
    "Loan": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Loan",
      "type": "object",
      "description": "Represents a loan issued to a borrower.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Loan entity."
        },
        "branchId": {
          "type": "string",
          "description": "Reference to Branch. (Relationship: Branch 1:N Loan)"
        },
        "borrowerId": {
          "type": "string",
          "description": "Reference to Borrower. (Relationship: Borrower 1:N Loan)"
        },
        "loanProductId": {
          "type": "string",
          "description": "Reference to LoanProduct. (Relationship: LoanProduct 1:N Loan)"
        },
        "itemValue": {
          "type": "number",
          "description": "The value of the item being financed."
        },
        "initialDeposit": {
          "type": "number",
          "description": "The initial deposit made by the borrower."
        },
        "duration": {
          "type": "number",
          "description": "The duration of the loan."
        },
        "financedPrincipal": {
          "type": "number",
          "description": "The financed principal amount (item value - deposit)."
        },
        "totalPayableAmount": {
          "type": "number",
          "description": "The total amount payable (financed principal + interest)."
        },
        "installmentAmount": {
          "type": "number",
          "description": "The installment amount per cycle."
        },
        "status": {
          "type": "string",
          "description": "The current status of the loan (Draft, Pending Approval, Approved, Active, Completed, etc.)."
        }
      },
      "required": [
        "id",
        "branchId",
        "borrowerId",
        "loanProductId",
        "itemValue",
        "initialDeposit",
        "duration"
      ]
    },
    "RepaymentSchedule": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RepaymentSchedule",
      "type": "object",
      "description": "Represents a single installment in the loan repayment schedule.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the RepaymentSchedule entity."
        },
        "loanId": {
          "type": "string",
          "description": "Reference to Loan. (Relationship: Loan 1:N RepaymentSchedule)"
        },
        "installmentNumber": {
          "type": "number",
          "description": "The installment number in the schedule."
        },
        "dueDate": {
          "type": "string",
          "description": "The due date for the installment.",
          "format": "date-time"
        },
        "expectedAmount": {
          "type": "number",
          "description": "The expected amount for the installment."
        },
        "status": {
          "type": "string",
          "description": "The status of the installment (Unpaid, Paid, Partial)."
        }
      },
      "required": [
        "id",
        "loanId",
        "installmentNumber",
        "dueDate",
        "expectedAmount",
        "status"
      ]
    },
    "Payment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Payment",
      "type": "object",
      "description": "Represents a payment made by a borrower.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Payment entity."
        },
        "branchId": {
          "type": "string",
          "description": "Reference to Branch. (Relationship: Branch 1:N Payment)"
        },
        "loanId": {
          "type": "string",
          "description": "Reference to Loan. (Relationship: Loan 1:N Payment)"
        },
        "paymentAmount": {
          "type": "number",
          "description": "The amount paid by the borrower."
        },
        "paymentMethod": {
          "type": "string",
          "description": "The method of payment (cash, bank, mobile money)."
        },
        "transactionReference": {
          "type": "string",
          "description": "The transaction reference number."
        },
        "notes": {
          "type": "string",
          "description": "Any notes related to the payment."
        },
        "timestamp": {
          "type": "string",
          "description": "The timestamp of the payment.",
          "format": "date-time"
        },
        "collectedByUserId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Payment) The user who collected the payment."
        }
      },
      "required": [
        "id",
        "branchId",
        "loanId",
        "paymentAmount",
        "paymentMethod",
        "timestamp",
        "collectedByUserId"
      ]
    },
    "PaymentAllocation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PaymentAllocation",
      "type": "object",
      "description": "Represents the allocation of a payment to a specific repayment schedule installment.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the PaymentAllocation entity."
        },
        "paymentId": {
          "type": "string",
          "description": "Reference to Payment. (Relationship: Payment 1:N PaymentAllocation)"
        },
        "repaymentScheduleId": {
          "type": "string",
          "description": "Reference to RepaymentSchedule. (Relationship: RepaymentSchedule 1:N PaymentAllocation)"
        },
        "allocatedAmount": {
          "type": "number",
          "description": "The amount allocated to the installment."
        }
      },
      "required": [
        "id",
        "paymentId",
        "repaymentScheduleId",
        "allocatedAmount"
      ]
    },
    "Permission": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Permission",
      "type": "object",
      "description": "Represents a specific permission that can be assigned to a role.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Permission entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the permission."
        },
        "description": {
          "type": "string",
          "description": "A description of what the permission allows."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "AuditLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AuditLog",
      "type": "object",
      "description": "Represents an audit log entry for tracking important actions.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AuditLog entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. The user who performed the action."
        },
        "timestamp": {
          "type": "string",
          "description": "The timestamp of the action.",
          "format": "date-time"
        },
        "action": {
          "type": "string",
          "description": "The action performed (e.g., Loan Approval, Repayment, Role Change)."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the action performed."
        },
        "branchId": {
          "type": "string",
          "description": "Reference to Branch. The branch the action occurred in."
        }
      },
      "required": [
        "id",
        "userId",
        "timestamp",
        "action",
        "description"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/organizations/{organizationId}",
        "definition": {
          "entityName": "Organization",
          "schema": {
            "$ref": "#/backend/entities/Organization"
          },
          "description": "Stores organization data. Includes denormalized 'ownerId' for authorization independence.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique identifier of the organization."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/branches/{branchId}",
        "definition": {
          "entityName": "Branch",
          "schema": {
            "$ref": "#/backend/entities/Branch"
          },
          "description": "Stores branch data. Requires the organizationId for hierarchy. Includes denormalized 'organizationId' and 'members' map for authorization independence.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique identifier of the organization."
            },
            {
              "name": "branchId",
              "description": "The unique identifier of the branch."
            }
          ]
        }
      },
      {
        "path": "/roles/{roleId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Stores role definitions.",
          "params": [
            {
              "name": "roleId",
              "description": "The unique identifier of the role."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user data. Includes denormalized 'roleId' and 'branchIds' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/branches/{branchId}/borrowers/{borrowerId}",
        "definition": {
          "entityName": "Borrower",
          "schema": {
            "$ref": "#/backend/entities/Borrower"
          },
          "description": "Stores borrower data. Requires branchId for the relationship. Includes denormalized 'branchId' for authorization independence.",
          "params": [
            {
              "name": "branchId",
              "description": "The unique identifier of the branch."
            },
            {
              "name": "borrowerId",
              "description": "The unique identifier of the borrower."
            }
          ]
        }
      },
      {
        "path": "/branches/{branchId}/borrowers/{borrowerId}/documents/{documentId}",
        "definition": {
          "entityName": "BorrowerDocument",
          "schema": {
            "$ref": "#/backend/entities/BorrowerDocument"
          },
          "description": "Stores borrower documents. Requires borrowerId and branchId for hierarchy. Includes denormalized 'borrowerId' and 'branchId' for authorization independence.",
          "params": [
            {
              "name": "branchId",
              "description": "The unique identifier of the branch."
            },
            {
              "name": "borrowerId",
              "description": "The unique identifier of the borrower."
            },
            {
              "name": "documentId",
              "description": "The unique identifier of the borrower document."
            }
          ]
        }
      },
      {
        "path": "/loanProducts/{loanProductId}",
        "definition": {
          "entityName": "LoanProduct",
          "schema": {
            "$ref": "#/backend/entities/LoanProduct"
          },
          "description": "Stores loan product definitions.",
          "params": [
            {
              "name": "loanProductId",
              "description": "The unique identifier of the loan product."
            }
          ]
        }
      },
      {
        "path": "/branches/{branchId}/loans/{loanId}",
        "definition": {
          "entityName": "Loan",
          "schema": {
            "$ref": "#/backend/entities/Loan"
          },
          "description": "Stores loan data. Requires branchId for the relationship. Includes denormalized 'branchId' and 'borrowerId' for authorization independence.",
          "params": [
            {
              "name": "branchId",
              "description": "The unique identifier of the branch."
            },
            {
              "name": "loanId",
              "description": "The unique identifier of the loan."
            }
          ]
        }
      },
      {
        "path": "/branches/{branchId}/loans/{loanId}/repaymentSchedules/{repaymentScheduleId}",
        "definition": {
          "entityName": "RepaymentSchedule",
          "schema": {
            "$ref": "#/backend/entities/RepaymentSchedule"
          },
          "description": "Stores repayment schedule data. Requires loanId and branchId for hierarchy. Includes denormalized 'loanId' and 'branchId' for authorization independence.",
          "params": [
            {
              "name": "branchId",
              "description": "The unique identifier of the branch."
            },
            {
              "name": "loanId",
              "description": "The unique identifier of the loan."
            },
            {
              "name": "repaymentScheduleId",
              "description": "The unique identifier of the repayment schedule."
            }
          ]
        }
      },
      {
        "path": "/branches/{branchId}/loans/{loanId}/payments/{paymentId}",
        "definition": {
          "entityName": "Payment",
          "schema": {
            "$ref": "#/backend/entities/Payment"
          },
          "description": "Stores payment data. Requires loanId and branchId for hierarchy. Includes denormalized 'loanId', 'branchId', and 'collectedByUserId' for authorization independence.",
          "params": [
            {
              "name": "branchId",
              "description": "The unique identifier of the branch."
            },
            {
              "name": "loanId",
              "description": "The unique identifier of the loan."
            },
            {
              "name": "paymentId",
              "description": "The unique identifier of the payment."
            }
          ]
        }
      },
      {
        "path": "/branches/{branchId}/loans/{loanId}/payments/{paymentId}/paymentAllocations/{paymentAllocationId}",
        "definition": {
          "entityName": "PaymentAllocation",
          "schema": {
            "$ref": "#/backend/entities/PaymentAllocation"
          },
          "description": "Stores payment allocation data. Requires paymentId, loanId, and branchId for hierarchy. Includes denormalized 'paymentId', 'loanId', and 'branchId' for authorization independence.",
          "params": [
            {
              "name": "branchId",
              "description": "The unique identifier of the branch."
            },
            {
              "name": "loanId",
              "description": "The unique identifier of the loan."
            },
            {
              "name": "paymentId",
              "description": "The unique identifier of the payment."
            },
            {
              "name": "paymentAllocationId",
              "description": "The unique identifier of the payment allocation."
            }
          ]
        }
      },
      {
        "path": "/permissions/{permissionId}",
        "definition": {
          "entityName": "Permission",
          "schema": {
            "$ref": "#/backend/entities/Permission"
          },
          "description": "Stores permission definitions.",
          "params": [
            {
              "name": "permissionId",
              "description": "The unique identifier of the permission."
            }
          ]
        }
      },
      {
        "path": "/auditLogs/{auditLogId}",
        "definition": {
          "entityName": "AuditLog",
          "schema": {
            "$ref": "#/backend/entities/AuditLog"
          },
          "description": "Stores audit log entries. Includes denormalized 'userId' and 'branchId' for authorization and filtering.",
          "params": [
            {
              "name": "auditLogId",
              "description": "The unique identifier of the audit log entry."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection indicate the user is an admin.  Existence-based rule.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support Adoo's multi-branch microfinance lending platform, focusing on security, scalability, and ease of maintenance. It adheres to the core design principles of Authorization Independence, Clarity of Intent, DBAC, and QAPs.  Authorization Independence is achieved through denormalization of authorization data, specifically the `members` map, into subcollections where access control is required. This eliminates the need for `get()` calls in security rules, enabling atomic operations and simplifying debugging. Structural Segregation is used to group data with similar access requirements into separate collections. For example, user-owned data is stored under `/users/{userId}`, while organization-level data is stored at the root level. Access Modeling follows consistent patterns, using path-based ownership for private data and the Membership Map pattern for collaborative data. Global roles are managed using dedicated collections (e.g., `/roles_admin/{uid}`). The structure supports the required QAPs by segregating data based on access levels and using membership maps for collaborative access. This allows for secure `list` operations, as rules can be based on the existence of a user in a membership map or the user's ownership of a resource. Data Clarity and Predictability are ensured by using explicit state modeling (e.g., a `status` field) and predictable schema. Naming conventions are standardized, and wildcard names are descriptive."
  }
}