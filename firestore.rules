rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isMe(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.roleId;
    }

    function isRole(userId, role) {
      return getUserRole(userId) == role;
    }

    function isAdmin() {
      return isRole(request.auth.uid, 'admin');
    }

    function isManager() {
      return isRole(request.auth.uid, 'manager');
    }

    function isLoanOfficer() {
      return isRole(request.auth.uid, 'loan_officer');
    }
    
    function isUser() {
        return isRole(request.auth.uid, 'user');
    }

    function userIsInBranch(branchId) {
        return branchId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchIds;
    }

    // This allows collection group queries on installments for dashboards
    match /{path=**}/installments/{installmentId} {
      // Admins and managers can list all installments for analytics.
      allow read: if isAdmin() || isManager();
    }

    match /users/{userId} {
      // Admins can manage any user. Managers can view users in their branch. Users can read their own data.
      allow read: if isAdmin() || (isManager() && userIsInBranch(resource.data.branchId)) || isMe(userId);
      // Allow user to create their own document.
      allow create: if isMe(userId);
      // Allow admin to update any user, and a user to update their own profile.
      allow update: if isAdmin() || isMe(userId);
      allow delete: if isAdmin();
    }
    
    match /roles/{roleId} {
      // All authenticated users can read roles to understand permissions.
      allow read: if isAuthenticated();
      // Only admins can create/update roles.
      allow write: if isAdmin();
    }
    
    match /branches/{branchId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /borrowers/{borrowerId} {
      // Admins can read all borrowers. Managers & loan officers can read borrowers in their branch.
      // A user can read their own borrower profile.
      allow read: if isAdmin() 
                  || ((isManager() || isLoanOfficer()) && userIsInBranch(resource.data.branchId))
                  || (isUser() && resource.data.userId == request.auth.uid);

      // Loan officers or higher can create/update borrowers.
      allow create, update: if isLoanOfficer() || isManager() || isAdmin();
      // Only managers and admins can delete borrowers.
      allow delete: if isManager() || isAdmin();
    }

    match /registrationPayments/{paymentId} {
      allow create: if isLoanOfficer() || isManager() || isAdmin();
      allow read: if isAuthenticated();
    }

    match /loanProducts/{productId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }

    match /loans/{loanId} {
      // Admins can read all. Managers their branch. Loan officers their assigned loans. Users their own loans.
      allow read: if isAdmin() 
                  || (isManager() && userIsInBranch(resource.data.branchId))
                  || (isLoanOfficer() && resource.data.loanOfficerId == request.auth.uid)
                  || (isUser() && get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId == request.auth.uid);

      allow create: if isLoanOfficer() || isManager() || isAdmin();
      // Only manager or admin can approve/reject (update status)
      allow update: if isManager() || isAdmin();
      allow delete: if isAdmin();
    }

    match /loans/{loanId}/installments/{installmentId} {
      // Permissions to read installments are inherited from the parent loan.
      // Staff can create/update installments.
      allow read: if (
                    let loan = get(/databases/$(database)/documents/loans/$(loanId)).data;
                    isAdmin() 
                    || (isManager() && userIsInBranch(loan.branchId))
                    || (isLoanOfficer() && loan.loanOfficerId == request.auth.uid)
                    || (isUser() && get(/databases/$(database)/documents/borrowers/$(loan.borrowerId)).data.userId == request.auth.uid)
                  );
      allow write: if isManager() || isAdmin() || isLoanOfficer();
    }

    match /auditLogs/{logId} {
        allow read, create: if isAdmin();
    }

    match /repayments/{repaymentId} {
      allow read, create: if isLoanOfficer() || isManager() || isAdmin();
    }
  }
}
