rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isMe(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getUserRole() {
      return getUserData().roleId;
    }

    function isRole(role) {
      return getUserRole() == role;
    }

    function isAdmin() {
      return isRole('admin');
    }

    function isManager() {
      return isRole('manager');
    }

    function isLoanOfficer() {
      return isRole('loan_officer');
    }
    
    function isUser() {
        return isRole('user');
    }

    function userIsInBranch(branchId) {
        return branchId in getUserData().branchIds;
    }
    
    function userIsAllowedBranch(branchId) {
      return branchId in getUserData().branchIds;
    }

    match /{path=**}/installments/{installmentId} {
      allow read: if isAdmin() || isManager();
    }

    match /users/{userId} {
      allow get: if isAdmin() || isManager() || isLoanOfficer() || isMe(userId);
       allow list: if request.query.where.organizationId == getUserData().organizationId &&
                   (isAdmin()
                  || ((isManager() || isLoanOfficer()) 
                      && 'roleId' in request.query.where && request.query.where.roleId == 'user'
                      && 'branchIds' in request.query.where && userIsAllowedBranch(request.query.where.branchIds['array-contains'])));
      allow create: if isMe(userId);
      allow update: if isAdmin() || isMe(userId);
      allow delete: if isAdmin();
    }
    
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /branches/{branchId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /borrowers/{borrowerId} {
      allow get: if isAdmin() 
                  || ((isManager() || isLoanOfficer()) && userIsInBranch(resource.data.branchId))
                  || (isUser() && resource.data.userId == request.auth.uid);
      
      allow list: if request.query.where.organizationId == getUserData().organizationId &&
                   (
                     isAdmin() ||
                     (
                       (isManager() || isLoanOfficer()) &&
                       'branchId' in request.query.where &&
                       request.query.where.branchId is list &&
                       request.query.where.branchId.size() <= 30 &&
                       request.query.where.branchId.forall(b, userIsAllowedBranch(b))
                     ) ||
                     (
                       isUser() &&
                       'userId' in request.query.where &&
                       request.query.where.userId == request.auth.uid
                     )
                   );

      allow create, update: if isLoanOfficer() || isManager() || isAdmin();
      allow delete: if isManager() || isAdmin();
    }

    match /registrationPayments/{paymentId} {
      allow create: if isLoanOfficer() || isManager() || isAdmin();
      allow read: if isAuthenticated();
    }

    match /loanProducts/{productId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }

    match /loans/{loanId} {
      allow get: if isAdmin() 
                  || (isManager() && userIsInBranch(resource.data.branchId))
                  || (isLoanOfficer() && resource.data.loanOfficerId == request.auth.uid)
                  || (isUser() && get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId == request.auth.uid);
      
      allow list: if request.query.where.organizationId == getUserData().organizationId && (
                    isAdmin() 
                    || (isManager() && 
                        'branchId' in request.query.where &&
                        request.query.where.branchId is list &&
                        request.query.where.branchId.size() <= 30 &&
                        request.query.where.branchId.forall(b, userIsAllowedBranch(b))
                    )
                    || (isLoanOfficer() && 'loanOfficerId' in request.query.where && request.query.where.loanOfficerId == request.auth.uid)
                  );

      allow create: if isLoanOfficer() || isManager() || isAdmin();
      allow update: if isManager() || isAdmin();
      allow delete: if isAdmin();
    }

    match /loans/{loanId}/installments/{installmentId} {
      allow read: if (
                    let loan = get(/databases/$(database)/documents/loans/$(loanId)).data;
                    isAdmin() 
                    || (isManager() && userIsInBranch(loan.branchId))
                    || (isLoanOfficer() && loan.loanOfficerId == request.auth.uid)
                    || (isUser() && get(/databases/$(database)/documents/borrowers/$(loan.borrowerId)).data.userId == request.auth.uid)
                  );
      allow write: if isManager() || isAdmin() || isLoanOfficer();
    }

    match /auditLogs/{logId} {
        allow read, create: if isAdmin();
    }

    match /repayments/{repaymentId} {
      allow read, create: if isLoanOfficer() || isManager() || isAdmin();
    }
  }
}
