rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // HELPER FUNCTIONS
    
    // Get the authenticated user's data from the /users collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if the user's role is in a list of roles
    function isUserInRole(roles) {
      return getUserData().roleId in roles;
    }

    // Check if the user is assigned to a specific branch
    function isAssignedToBranch(branchId) {
      return branchId in getUserData().branchIds;
    }
    
    // Superadmin and Admin have broad permissions
    function isPrivilegedUser() {
      return isUserInRole(['superadmin', 'admin']);
    }
    
    // Check if the request is from the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // RULES FOR COLLECTIONS
    
    // USERS: Manage user profiles
    match /users/{userId} {
      // READ: Users can read their own profile. Admins/Superadmins can read any user in their org.
      // Managers/Officers can only read 'user' (borrower) role profiles in their assigned branches.
      allow read: if request.auth != null && (
        isOwner(userId) ||
        (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId) ||
        (isUserInRole(['manager', 'loan_officer']) &&
         get(/databases/$(database)/documents/users/$(userId)).data.roleId == 'user' &&
         isAssignedToBranch(get(/databases/$(database)/documents/users/$(userId)).data.branchIds[0]))
      );
      
      // CREATE: A user can create their own profile during signup.
      // Staff can create new users. Loan officers/managers can only create 'user' (borrower) accounts.
      allow create: if request.auth != null && (
        isOwner(userId) || // for self-signup
        (isUserInRole(['loan_officer', 'manager']) && request.resource.data.roleId == 'user') || // officers/managers can create borrowers
        isPrivilegedUser() // admins can create any staff
      );

      // UPDATE: A user can update their own profile. Admins can update any user in their org.
      // Loan officers/managers can update borrower accounts in their branch.
      allow update: if request.auth != null && (
        isOwner(userId) || 
        (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId && resource.data.roleId != 'superadmin') ||
        (
          (isUserInRole(['loan_officer', 'manager'])) &&
          resource.data.roleId == 'user' &&
          isAssignedToBranch(resource.data.branchIds[0]) &&
          request.resource.data.roleId == resource.data.roleId &&
          request.resource.data.branchIds == resource.data.branchIds
        )
      );
      
      // DELETE: Admin can delete any user except superadmins and themselves. Superadmin can delete any user except themselves.
      allow delete: if request.auth != null &&
        !isOwner(userId) &&
        resource.data.roleId != 'superadmin' &&
        (isUserInRole(['superadmin']) || (isUserInRole(['admin']) && resource.data.roleId != 'admin'));
    }

    // ROLES: System-level role definitions
    match /roles/{roleId} {
      // READ: All authenticated users can read role definitions.
      allow read: if request.auth != null;
      // WRITE: Only superadmins can modify roles.
      allow write: if request.auth != null && isUserInRole(['superadmin']);
    }
    
    // BRANCHES: Organization branch locations
    match /branches/{branchId} {
        // READ: Staff members can see branches in their organization.
        allow read: if request.auth != null && 
            isUserInRole(['superadmin', 'admin', 'manager', 'loan_officer']) && 
            getUserData().organizationId == resource.data.organizationId;
        
        // WRITE: Only privileged users (Admins/Superadmins) can create or modify branches.
        allow write: if request.auth != null && isPrivilegedUser();
    }
    
    // BORROWERS: Client profiles
    match /borrowers/{borrowerId} {
      // READ: A user can read their own borrower profile. Staff can read borrowers in their branch or organization.
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/borrowers/$(borrowerId)).data.userId == request.auth.uid ||
        (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId) ||
        (isUserInRole(['manager', 'loan_officer']) && isAssignedToBranch(resource.data.branchId))
      );
      
      // WRITE: Loan Officers, Managers, and Admins can create/update borrowers within their scope.
      allow write: if request.auth != null && (
        isPrivilegedUser() ||
        (isUserInRole(['manager', 'loan_officer']) && isAssignedToBranch(request.resource.data.branchId))
      );

      // INTERACTIONS: Sub-collection for follow-up notes
      match /interactions/{interactionId} {
        // READ: Staff can read interactions for borrowers in their scope.
        allow read: if request.auth != null && (
            (isPrivilegedUser() && getUserData().organizationId == get(/databases/$(database)/documents/borrowers/$(borrowerId)).data.organizationId) ||
            (isUserInRole(['manager', 'loan_officer']) && isAssignedToBranch(get(/databases/$(database)/documents/borrowers/$(borrowerId)).data.branchId))
        );

        // CREATE: Loan officers and managers can add notes for borrowers in their branch.
        allow create: if request.auth != null && (
            isUserInRole(['manager', 'loan_officer']) &&
            isAssignedToBranch(get(/databases/$(database)/documents/borrowers/$(borrowerId)).data.branchId) &&
            request.resource.data.recordedById == request.auth.uid
        );
      }
    }
    
    // LOAN PRODUCTS: Definitions for loan types
    match /loanProducts/{productId} {
      // READ: All staff can read loan products.
      allow read: if request.auth != null && isUserInRole(['superadmin', 'admin', 'manager', 'loan_officer']);
      // WRITE: Only privileged users can manage loan products.
      allow write: if request.auth != null && isPrivilegedUser();
    }
    
    // LOANS: The core of the application
    match /loans/{loanId} {
      // Helper to get incoming data for write rules
      function incomingData() {
        return request.resource.data;
      }
      
      // READ: A borrower can read their own loan. Staff can read loans within their scope.
      allow read: if request.auth != null && (
          (
            // This checks if the user trying to read the loan is the one linked to the loan's borrower profile
            exists(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)) &&
            get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId == request.auth.uid
          ) ||
          (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId) ||
          (isUserInRole(['manager', 'loan_officer']) && isAssignedToBranch(resource.data.branchId))
      );
        
      // CREATE: Loan officers/Managers can create loans for borrowers in their branch.
      allow create: if request.auth != null &&
        (isUserInRole(['loan_officer', 'manager']) && 
         isAssignedToBranch(incomingData().branchId) &&
         incomingData().loanOfficerId == request.auth.uid &&
         incomingData().status == 'Pending Approval');

      // UPDATE: Handle the loan lifecycle (approval, disbursal)
      allow update: if request.auth != null &&
        // Ensure core fields that link a loan to a borrower, org, branch, and product are immutable.
        incomingData().borrowerId == resource.data.borrowerId &&
        incomingData().organizationId == resource.data.organizationId &&
        incomingData().branchId == resource.data.branchId &&
        incomingData().loanProductId == resource.data.loanProductId &&
        (
            // Manager can approve or reject a pending loan for their branch.
            (isUserInRole(['manager']) && isAssignedToBranch(resource.data.branchId) &&
                resource.data.status == 'Pending Approval' &&
                (incomingData().status == 'Approved' || incomingData().status == 'Rejected') &&
                incomingData().approvedById == request.auth.uid
            ) ||
            // Admin/Superadmin can disburse, complete, or make other general edits (like changing principal or officer).
            (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId)
        );
      
      // DELETE: Only Superadmin for cleanup.
      allow delete: if request.auth != null && isUserInRole(['superadmin']);

      // INSTALLMENTS: Sub-collection for loan repayments
      match /installments/{installmentId} {
        // This rule supports both direct subcollection access and collection group queries
        allow read: if request.auth != null && (
            // Borrower can read their own installments by checking through the borrower document
            (exists(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)) &&
             get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId == request.auth.uid) ||
            // Staff access based on role and scope
            (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId) ||
            (isUserInRole(['manager']) && isAssignedToBranch(resource.data.branchId)) ||
            (isUserInRole(['loan_officer']) && request.auth.uid == resource.data.loanOfficerId)
        );
        
        // WRITE: Only Admins/Superadmins can create/update installments (as part of loan disbursement or manual completion).
        allow write: if request.auth != null && isPrivilegedUser();
      }
    }

    // TARGETS: Performance goals
    match /targets/{targetId} {
        // READ: Admins can read all targets in their org. Managers can read targets for their branch.
        allow read: if request.auth != null && (
            (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId) ||
            (isUserInRole(['manager']) && isAssignedToBranch(resource.data.branchId))
        );
        // WRITE: Only privileged users can create or modify targets.
        allow write: if request.auth != null && isPrivilegedUser();
    }
    
    // ORGANIZATIONS
    match /organizations/{organizationId} {
        allow read: if request.auth != null && getUserData().organizationId == organizationId;
        allow update: if request.auth != null && isPrivilegedUser() && getUserData().organizationId == organizationId;
    }

    // REPAYMENTS
    match /repayments/{repaymentId} {
        allow read: if request.auth != null && (
            (exists(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)) && get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId == request.auth.uid) ||
            (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId) ||
            (isUserInRole(['manager']) && isAssignedToBranch(get(/databases/$(database)/documents/loans/$(resource.data.loanId)).data.branchId)) ||
            (isUserInRole(['loan_officer']) && resource.data.loanOfficerId == request.auth.uid)
        );
        allow create: if request.auth != null && isUserInRole(['loan_officer', 'manager']);
    }

    // REGISTRATION PAYMENTS
    match /registrationPayments/{paymentId} {
        allow read: if request.auth != null && (
            (exists(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)) && get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId == request.auth.uid) ||
            (isPrivilegedUser() && getUserData().organizationId == resource.data.organizationId) ||
            (isUserInRole(['manager', 'loan_officer']) && isAssignedToBranch(get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.branchId))
        );
        allow create: if request.auth != null && isUserInRole(['loan_officer', 'manager']);
    }

    // BACKEND-ONLY COLLECTIONS
    match /mpesa_callbacks/{docId} {
      allow read: if request.auth != null && isPrivilegedUser();
      allow write: if false; // Only backend can write
    }

    match /failed_mpesa_callbacks/{docId} {
      allow read: if request.auth != null && isPrivilegedUser();
      allow write: if false; // Only backend can write
    }

    match /auditLogs/{logId} {
      allow read: if request.auth != null && isPrivilegedUser();
      allow write: if false; // Only backend can write
    }
  }
}
