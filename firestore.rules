rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================
    // Helper Functions
    // =================================
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isUserRole(userId, role) {
      return getUserData(userId).roleId == role;
    }
    
    function isUserInOrg(userId, orgId) {
      return getUserData(userId).organizationId == orgId;
    }

    function isStaff(userId) {
      return getUserData(userId).roleId != 'user';
    }

    // =================================
    // Collections
    // =================================

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Organizations: Superadmin can manage all. Admin can manage their own.
    match /organizations/{orgId} {
      allow read: if request.auth != null && (isUserInOrg(request.auth.uid, orgId) || isUserRole(request.auth.uid, 'superadmin'));
      allow write: if request.auth != null && (isUserRole(request.auth.uid, 'superadmin') || (isUserRole(request.auth.uid, 'admin') && isUserInOrg(request.auth.uid, orgId)));
    }
    
    // Roles: Superadmin can manage. Everyone else can read.
    match /roles/{roleId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isUserRole(request.auth.uid, 'superadmin');
    }

    // Users: Users can read/update their own profile. Admins/Superadmins manage others.
    match /users/{userId} {
      allow get: if request.auth != null; // Allow any authenticated user to get any profile to check roles. Client-side queries should restrict visibility.
      allow list: if request.auth != null && (isUserRole(request.auth.uid, 'superadmin') || isUserRole(request.auth.uid, 'admin'));
      allow create: if true; // Allow user creation during signup for anyone
      allow update: if request.auth != null && (
        request.auth.uid == userId || // User can update their own profile
        isUserRole(request.auth.uid, 'superadmin') || // Superadmin can update anyone
        (isUserRole(request.auth.uid, 'admin') && isUserInOrg(request.auth.uid, resource.data.organizationId)) // Admin can update users in their org
      );
    }

    // Branches: Superadmin can manage all. Admin/Manager can manage their own org's branches.
    match /branches/{branchId} {
        let branchData = get(/databases/$(database)/documents/branches/$(branchId)).data;
        allow read: if request.auth != null && (isUserInOrg(request.auth.uid, branchData.organizationId) || isUserRole(request.auth.uid, 'superadmin'));
        allow write: if request.auth != null && (
            isUserRole(request.auth.uid, 'superadmin') ||
            ((isUserRole(request.auth.uid, 'admin') || isUserRole(request.auth.uid, 'manager')) && isUserInOrg(request.auth.uid, branchData.organizationId))
        );
    }
    
    // Loan Products: Superadmin can manage all. Admin can manage their own org's products.
    match /loanProducts/{productId} {
        let productData = get(/databases/$(database)/documents/loanProducts/$(productId)).data;
        allow read: if request.auth != null && (isUserInOrg(request.auth.uid, productData.organizationId) || isUserRole(request.auth.uid, 'superadmin'));
        allow write: if request.auth != null && (
            isUserRole(request.auth.uid, 'superadmin') ||
            (isUserRole(request.auth.uid, 'admin') && isUserInOrg(request.auth.uid, productData.organizationId))
        );
    }
    
    // Borrowers: Staff manage borrowers in their org. Borrowers see their own profile.
    match /borrowers/{borrowerId} {
        let borrowerData = get(/databases/$(database)/documents/borrowers/$(borrowerId)).data;
        allow get: if request.auth != null && (
            request.auth.uid == borrowerData.userId || // Borrower can get their own profile
            isUserRole(request.auth.uid, 'superadmin') || // Superadmin can get any profile
            (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, borrowerData.organizationId)) // Staff can get profiles in their org
        );
        allow list: if request.auth != null && (isUserRole(request.auth.uid, 'superadmin') || isUserRole(request.auth.uid, 'admin'));
        allow create: if request.auth != null && (
            isUserRole(request.auth.uid, 'superadmin') ||
            (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, request.resource.data.organizationId))
        );
        allow update: if request.auth != null && (
            isUserRole(request.auth.uid, 'superadmin') ||
            (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, resource.data.organizationId))
        );
    }

    // Loans & Installments
    match /loans/{loanId} {
        let loanData = get(/databases/$(database)/documents/loans/$(loanId)).data;
        let borrowerData = get(/databases/$(database)/documents/borrowers/$(loanData.borrowerId)).data;

        allow read: if request.auth != null && (
            request.auth.uid == borrowerData.userId || // Borrower can read their own loan
            isUserRole(request.auth.uid, 'superadmin') || // Superadmin can read any loan
            (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, loanData.organizationId)) // Staff can read loans in their org
        );
        allow list: if request.auth != null && isStaff(request.auth.uid); // Any staff can list, client code must filter

        allow create: if request.auth != null && (
            isUserRole(request.auth.uid, 'superadmin') ||
            (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, request.resource.data.organizationId))
        );
        allow update: if request.auth != null && (
            isUserRole(request.auth.uid, 'superadmin') ||
            ((isUserRole(request.auth.uid, 'admin') || isUserRole(request.auth.uid, 'manager')) && isUserInOrg(request.auth.uid, resource.data.organizationId))
        );

        match /installments/{installmentId} {
            // Inherit read access from parent loan
            allow read: if request.auth != null && (
                request.auth.uid == borrowerData.userId ||
                isUserRole(request.auth.uid, 'superadmin') ||
                (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, loanData.organizationId))
            );
            // Only allow updates from higher-level staff or system processes
            allow write: if request.auth != null && (
                isUserRole(request.auth.uid, 'superadmin') ||
                ((isUserRole(request.auth.uid, 'admin') || isUserRole(request.auth.uid, 'manager')) && isUserInOrg(request.auth.uid, loanData.organizationId))
            );
        }
    }
    
    // Repayments & Registration Payments
    match /repayments/{repaymentId} {
        let repaymentData = get(/databases/$(database)/documents/repayments/$(repaymentId)).data;
        let borrowerData = get(/databases/$(database)/documents/borrowers/$(repaymentData.borrowerId)).data;
        allow get: if request.auth != null && (
            request.auth.uid == borrowerData.userId ||
            isUserRole(request.auth.uid, 'superadmin') ||
            (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, repaymentData.organizationId))
        );
        allow list: if request.auth != null && isStaff(request.auth.uid);
        allow create: if request.auth != null; // Allow system/staff to create
    }
    
    match /registrationPayments/{paymentId} {
        let paymentData = get(/databases/$(database)/documents/registrationPayments/$(paymentId)).data;
        let borrowerData = get(/databases/$(database)/documents/borrowers/$(paymentData.borrowerId)).data;
        allow get: if request.auth != null && (
            request.auth.uid == borrowerData.userId ||
            isUserRole(request.auth.uid, 'superadmin') ||
            (isStaff(request.auth.uid) && isUserInOrg(request.auth.uid, paymentData.organizationId))
        );
        allow list: if request.auth != null && isStaff(request.auth.uid);
        allow create: if request.auth != null && isStaff(request.auth.uid);
    }
    
    // Cloud Function data sinks - client should not write here.
    match /mpesa_callbacks/{docId} {
      allow read, write: if false;
    }
    match /failed_mpesa_callbacks/{docId} {
      allow read, write: if false;
    }
    match /auditLogs/{logId} {
        allow read, write: if false;
    }
  }
}
