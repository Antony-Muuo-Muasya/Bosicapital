rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Helper function to get the requesting user's data from the /users collection
    function getRequestingUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check if the requesting user has a specific role
    function isRequestingUserRole(role) {
      // Must check for auth not null, and that the user document exists
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getRequestingUserData().roleId == role;
    }
    
    // Helper function to check if the requesting user belongs to a specific organization
    function isRequestingUserInOrg(orgId) {
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getRequestingUserData().organizationId == orgId;
    }
    
    // =================================
    // Collections
    // =================================

    // Organizations: Superadmin can manage all. Admin can read/write their own organization document.
    match /organizations/{orgId} {
      allow read: if isRequestingUserRole('superadmin') || isRequestingUserInOrg(orgId);
      // For write, user must be a superadmin OR an admin of that specific organization.
      allow write: if isRequestingUserRole('superadmin') || (isRequestingUserRole('admin') && isRequestingUserInOrg(orgId));
    }
    
    // Roles: All authenticated users can read roles. Only superadmins can write them.
    match /roles/{roleId} {
      allow read: if request.auth != null;
      allow write: if isRequestingUserRole('superadmin');
    }

    // Users:
    match /users/{userId} {
      // Any authenticated user can read any user's profile (to check roles, etc.). Client-side code should limit what is displayed.
      allow get: if request.auth != null;
      // Listing users is restricted to admins and superadmins.
      allow list: if isRequestingUserRole('superadmin') || isRequestingUserRole('admin');
      
      // Anyone can create a user document during sign-up.
      allow create: if true; 
      
      // A user can update their own profile.
      // A superadmin can update any user.
      // An admin can update any user within their own organization.
      allow update: if (request.auth.uid == userId) || isRequestingUserRole('superadmin') || 
                     (isRequestingUserRole('admin') && isRequestingUserInOrg(resource.data.organizationId));
    }

    // Branches:
    match /branches/{branchId} {
        // Must check incoming data on create, and existing data on update/delete
        function isUserAuthorized() {
            let orgId = request.method == 'create' ? request.resource.data.organizationId : resource.data.organizationId;
            return isRequestingUserRole('superadmin') ||
                   ((isRequestingUserRole('admin') || isRequestingUserRole('manager')) && isRequestingUserInOrg(orgId));
        }
        allow read: if isRequestingUserRole('superadmin') || isRequestingUserInOrg(resource.data.organizationId);
        allow write: if isUserAuthorized();
    }
    
    // Loan Products:
    match /loanProducts/{productId} {
        function isUserAuthorized() {
            let orgId = request.method == 'create' ? request.resource.data.organizationId : resource.data.organizationId;
            return isRequestingUserRole('superadmin') ||
                   (isRequestingUserRole('admin') && isRequestingUserInOrg(orgId));
        }
        allow read: if isRequestingUserRole('superadmin') || isRequestingUserInOrg(resource.data.organizationId);
        allow write: if isUserAuthorized();
    }
    
    // Borrowers:
    match /borrowers/{borrowerId} {
        let borrowerOrgId = request.method == 'create' ? request.resource.data.organizationId : resource.data.organizationId;
        let borrowerUserId = request.method == 'create' ? request.resource.data.userId : resource.data.userId;

        allow get: if isRequestingUserRole('superadmin') || 
                    (request.auth.uid == borrowerUserId) ||
                    ((isRequestingUserRole('admin') || isRequestingUserRole('manager') || isRequestingUserRole('loan_officer')) && isRequestingUserInOrg(borrowerOrgId));
        
        allow list: if isRequestingUserRole('superadmin') || isRequestingUserRole('admin') || isRequestingUserRole('manager') || isRequestingUserRole('loan_officer');
        
        allow create, update: if isRequestingUserRole('superadmin') || 
                                ((isRequestingUserRole('admin') || isRequestingUserRole('manager') || isRequestingUserRole('loan_officer')) && isRequestingUserInOrg(request.resource.data.organizationId));
    }

    // Loans & Installments
    match /loans/{loanId} {
        let loanOrgId = request.method == 'create' ? request.resource.data.organizationId : resource.data.organizationId;
        // On read, need to get borrower's user ID from the loan document.
        let borrowerUserId = get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId;

        allow read: if isRequestingUserRole('superadmin') || 
                     (request.auth.uid == borrowerUserId) ||
                     ((isRequestingUserRole('admin') || isRequestingUserRole('manager') || isRequestingUserRole('loan_officer')) && isRequestingUserInOrg(loanOrgId));

        allow list: if isRequestingUserRole('superadmin') || isRequestingUserRole('admin') || isRequestingUserRole('manager') || isRequestingUserRole('loan_officer');

        allow create: if (isRequestingUserRole('superadmin') || (isRequestingUserRole('admin') || isRequestingUserRole('manager') || isRequestingUserRole('loan_officer'))) && isRequestingUserInOrg(request.resource.data.organizationId);
        
        allow update: if isRequestingUserRole('superadmin') || 
                       ((isRequestingUserRole('admin') || isRequestingUserRole('manager')) && isRequestingUserInOrg(resource.data.organizationId));

        match /installments/{installmentId} {
            // Inherit read access from parent loan
            allow read: if isRequestingUserRole('superadmin') || 
                         (request.auth.uid == borrowerUserId) ||
                         ((isRequestingUserRole('admin') || isRequestingUserRole('manager') || isRequestingUserRole('loan_officer')) && isRequestingUserInOrg(loanOrgId));
            
            // Only admins and managers can write installments (e.g. creating the schedule)
            allow write: if isRequestingUserRole('superadmin') || 
                          ((isRequestingUserRole('admin') || isRequestingUserRole('manager')) && isRequestingUserInOrg(get(/databases/$(database)/documents/loans/$(loanId)).data.organizationId));
        }
    }
    
    // Repayments & Registration Payments
    match /repayments/{repaymentId} {
      allow read, create: if request.auth != null; // Simplified for now, client code restricts view
    }
    
    match /registrationPayments/{paymentId} {
      allow read, create: if request.auth != null; // Simplified for now, client code restricts view
    }
    
    // Cloud Function data sinks - client should not write here.
    match /mpesa_callbacks/{docId} {
      allow read, write: if false;
    }
    match /failed_mpesa_callbacks/{docId} {
      allow read, write: if false;
    }
    match /auditLogs/{logId} {
        allow read, write: if false;
    }
  }
}