
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =================================
    // Helper Functions
    // =================================
    
    function getUserData(uid) {
      // Safely get data from the user's profile document.
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    function isRole(role) {
      // Check role only if the user document exists.
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData(request.auth.uid).roleId == role;
    }
    
    function isStaff() {
      if (!isSignedIn() || !exists(/databases/$(database)/documents/users/$(request.auth.uid))) {
        return false;
      }
      let userRole = getUserData(request.auth.uid).roleId;
      return userRole == 'admin' || userRole == 'manager' || userRole == 'loan_officer';
    }
    
    function isSameOrgAsRequest(resource) {
        if (!isSignedIn() || !exists(/databases/$(database)/documents/users/$(request.auth.uid))) {
            return false;
        }
        let userOrg = getUserData(request.auth.uid).organizationId;
        return resource.data.organizationId == userOrg;
    }
    
    // =================================
    // Collection Rules
    // =================================

    // Users can read their own profile. Staff can read any profile in their org.
    match /users/{userId} {
      allow get: if isOwner(userId) || (isStaff() && isSameOrgAsRequest(resource));
      // Only admins can list users, and only within their own org.
      allow list: if isRole('admin') && request.query.organizationId == getUserData(request.auth.uid).organizationId;
      // New users can create their own profile.
      allow create: if isOwner(userId);
      // Only admins can update user profiles.
      allow update: if isRole('admin') && isSameOrgAsRequest(resource);
      // Only admins can delete users.
      allow delete: if isRole('admin');
    }
    
    // All authenticated users can see what roles exist.
    match /roles/{roleId} {
      allow read: if isSignedIn();
      allow write: if false; // Roles are seeded, not client-writable
    }
    
    // Staff can read branches. Admins can write.
    match /branches/{branchId} {
      allow read: if isStaff();
      allow write: if isRole('admin');
    }
    
    // Staff can read/write borrowers. A borrower can read their own record.
    match /borrowers/{borrowerId} {
      allow get: if isStaff() || isOwner(resource.data.userId);
      allow list, create, update: if isStaff();
      allow delete: if isRole('admin');
    }
    
    // Staff can read/create loans. Borrowers can read their own loan. Admins approve.
    match /loans/{loanId} {
      allow get: if isStaff() || (exists(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)) && isOwner(get(/databases/$(database)/documents/borrowers/$(resource.data.borrowerId)).data.userId));
      allow list, create: if isStaff();
      allow update: if isRole('admin');
      allow delete: if false; // For data integrity
    }
    
    // Subcollection for loan installments.
    match /loans/{loanId}/installments/{installmentId} {
      allow read: if isStaff() || (exists(/databases/$(database)/documents/loans/$(loanId)) && exists(/databases/$(database)/documents/borrowers/$(get(/databases/$(database)/documents/loans/$(loanId)).data.borrowerId)) && isOwner(get(/databases/$(database)/documents/borrowers/$(get(/databases/$(database)/documents/loans/$(loanId)).data.borrowerId)).data.userId));
      allow write: if isRole('admin');
    }
    
    // Staff can read products. Admins can write.
    match /loanProducts/{loanProductId} {
      allow read: if isStaff();
      allow write: if isRole('admin');
    }
    
    // Staff can read/create repayments and registration payments.
    match /repayments/{repaymentId} {
      allow read, create: if isStaff();
      allow update, delete: if false;
    }
    
    match /registrationPayments/{paymentId} {
      allow read, create: if isStaff();
      allow update, delete: if false;
    }
    
    // Audit logs are admin-only
    match /auditLogs/{logId} {
        allow read, write: if isRole('admin');
    }
  }
}
